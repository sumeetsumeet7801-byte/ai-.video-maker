<!DOCTYPE html>
<html lang="kn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üé• AI Video Maker</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Segoe+UI&display=swap');
    :root{--bg1:#0f172a;--bg2:#1e293b;--text:#e0e7ff;--ring:#334155;--accent:#38bdf8;--accent2:#0ea5e9;--ok:#22c55e;--err:#fb7185;}
    *{box-sizing:border-box}
    body{background:linear-gradient(135deg,var(--bg1),var(--bg2));color:var(--text);font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;display:flex;flex-direction:column;align-items:center;min-height:100vh;padding:40px 20px;margin:0;overflow-x:hidden}
    h1{margin-bottom:12px;text-shadow:0 2px 8px rgba(56,189,248,.7)}
    .row{display:grid;gap:10px;grid-template-columns:1fr 1fr;max-width:700px;width:80%}
    @media (max-width:680px){.row{grid-template-columns:1fr}}
    textarea,select,button{width:80%;max-width:700px}
    textarea{height:140px;padding:15px;border-radius:12px;border:none;outline:none;font-size:18px;resize:vertical;background:#1e293b;color:var(--text);box-shadow:0 4px 15px rgba(56,189,248,.4);transition:box-shadow .3s}
    textarea:focus{box-shadow:0 0 15px 4px var(--accent)}
    select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--ring);background:#0b1220;color:var(--text)}
    .stack{display:flex;gap:10px;flex-wrap:wrap;max-width:700px;width:80%}
    button{margin-top:12px;padding:12px 30px;font-size:18px;color:#001018;background:linear-gradient(90deg,var(--accent),var(--accent2));border:none;border-radius:14px;cursor:pointer;font-weight:700;box-shadow:0 8px 25px rgba(56,189,248,.6);transition:transform .1s,filter .2s}
    .ghost{background:transparent;color:var(--text);border:1px solid var(--ring)}
    button:active{transform:scale(.98)}
    button:disabled{opacity:.6;cursor:not-allowed;filter:grayscale(.2)}
    video{margin-top:18px;max-width:80%;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.7);outline:2px solid var(--ring);background:#111827;display:none}
    .status{margin-top:10px;font-size:16px;font-weight:600;min-height:24px}
    .status.ok{color:var(--ok)} .status.err{color:var(--err)} .muted{color:#9aa3b2;font-size:.92rem}
    .download-btn{margin-top:12px;padding:10px 20px;font-size:16px;border:none;border-radius:12px;background:#f97316;color:#fff;display:none;text-decoration:none;text-align:center;box-shadow:0 6px 18px rgba(249,115,22,.8)}
    .bar-wrap{height:6px;background:#0b1220;border:1px solid var(--ring);border-radius:999px;max-width:700px;width:80%;margin-top:8px;overflow:hidden}
    .bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .3s}
    .dots{display:inline-grid;grid-auto-flow:column;gap:6px;margin-left:8px}
    .dots span{width:6px;height:6px;border-radius:999px;background:#9aa3b2;animation:b .9s infinite ease-in-out}
    .dots span:nth-child(2){animation-delay:.15s}.dots span:nth-child(3){animation-delay:.3s}
    @keyframes b{0%,80%,100%{opacity:.2;transform:translateY(0)}40%{opacity:1;transform:translateY(-4px)}}
  </style>
</head>
<body>
  <h1>üé• AI Video Maker</h1>

  <textarea id="scriptInput" placeholder="‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤µ‡≥Ä‡≤°‡≤ø‡≤Ø‡≥ã ‡≤∏‡≥ç‡≤ï‡≥ç‡≤∞‡≤ø‡≤™‡≥ç‡≤ü‡≥ç ‡≤á‡≤≤‡≥ç‡≤≤‡≤ø ‡≤ü‡≥à‡≤™‡≥ç ‡≤Æ‡≤æ‡≤°‡≤ø‚Ä¶"></textarea>

  <div class="row" style="margin-top:10px">
    <select id="aspect" aria-label="Aspect Ratio">
      <option value="16:9">16:9 (YouTube)</option>
      <option value="9:16">9:16 (Reels/Shorts)</option>
      <option value="1:1">1:1 (Square)</option>
    </select>
    <select id="style" aria-label="Visual Style">
      <option value="cinematic">Cinematic</option>
      <option value="documentary">Documentary</option>
      <option value="anime">Anime</option>
    </select>
  </div>

  <div class="stack">
    <button id="generateBtn">‚ú® Generate Video (Ctrl/‚åò+Enter)</button>
    <button class="ghost" id="sampleBtn" type="button">Paste sample</button>
    <button class="ghost" id="clearBtn" type="button">Clear</button>
  </div>

  <div class="status" id="status" role="status" aria-live="polite"></div>
  <div class="bar-wrap" aria-hidden="true"><div class="bar" id="bar"></div></div>

  <video id="outputVideo" controls></video>
  <a id="downloadLink" class="download-btn" href="#" download>‚¨áÔ∏è Download Video</a>
  <div class="muted" style="max-width:700px;width:80%;margin-top:8px">‡≤ü‡≤ø‡≤™‡≥ç: 1‚Äì3 ‡≤µ‡≤æ‡≤ï‡≥ç‡≤Ø‡≤ó‡≤≥ concise ‡≤∏‡≥ç‡≤ï‡≥ç‡≤∞‡≤ø‡≤™‡≥ç‡≤ü‡≥ç ‡≤â‡≤§‡≥ç‡≤§‡≤Æ ‡≤´‡≤≤‡≤ø‡≤§‡≤æ‡≤Ç‡≤∂ ‡≤ï‡≥ä‡≤°‡≥Å‡≤§‡≥ç‡≤§‡≤¶‡≥Ü.</div>

  <script>
    /* ============ CONFIG ============ */
    // üîÅ ‡≤®‡≤ø‡≤®‡≥ç‡≤® Worker ‡≤¨‡≥á‡≤∏‡≥ç URL (TRAILING / ‡≤¨‡≥á‡≤°)
    const WORKER_BASE = "https://sparkling-term-78f6.sumeetsumeet7801.workers.dev";

    /* ============ ELEMENTS ============ */
    const ta = document.getElementById("scriptInput");
    const btn = document.getElementById("generateBtn");
    const statusEl = document.getElementById("status");
    const videoEl = document.getElementById("outputVideo");
    const downloadLink = document.getElementById("downloadLink");
    const bar = document.getElementById("bar");

    /* ============ HELPERS ============ */
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    function setStatus(msg, type){ statusEl.className="status"+(type?(" "+type):""); statusEl.innerHTML=msg; }
    function lockUI(lock){ btn.disabled=lock; btn.innerText = lock ? "‡≤ú‡≤®‡≤∞‡≥á‡≤ü‡≥ç ‡≤Ü‡≤ó‡≥Å‡≤§‡≥ç‡≤§‡≤ø‡≤¶‡≥Ü‚Ä¶" : "‚ú® Generate Video"; }
    let progTimer=null;
    function startProgress(){ bar.style.width="5%"; clearInterval(progTimer); progTimer=setInterval(()=>{const cur=parseFloat(bar.style.width)||5; bar.style.width=Math.min(cur+(Math.random()*10+4),92)+"%";},600); }
    function stopProgress(full=true){ clearInterval(progTimer); bar.style.width= full? "100%":"0%"; if(full) setTimeout(()=> bar.style.width="0%",900); }
    async function safeText(res,fallback){ try{ return await res.text(); }catch{ return fallback; } }

    /* ============ UX ============ */
    ta.value = localStorage.getItem("last-script") || "";
    document.getElementById("sampleBtn").onclick = () => {
      ta.value = "Golden-hour aerial over green paddy fields in Karnataka, gentle drone forward, soft mist, cinematic grade.";
      ta.focus();
    };
    document.getElementById("clearBtn").onclick = () => {
      ta.value=""; setStatus(""); stopProgress(false); videoEl.src=""; videoEl.style.display="none"; downloadLink.style.display="none";
    };
    document.addEventListener("keydown",(e)=>{ if((e.metaKey||e.ctrlKey)&&e.key==="Enter") generateVideo(); });
    btn.onclick = generateVideo;

    /* ============ CORE FLOW ============ */
    async function generateVideo(){
      const script = ta.value.trim();
      const aspect = document.getElementById("aspect").value;
      const style  = document.getElementById("style").value;

      if(!script){ setStatus("‚ö†Ô∏è ‡≤¶‡≤Ø‡≤µ‡≤ø‡≤ü‡≥ç‡≤ü‡≥Å ‡≤∏‡≥ç‡≤ï‡≥ç‡≤∞‡≤ø‡≤™‡≥ç‡≤ü‡≥ç ‡≤®‡≤Æ‡≥Ç‡≤¶‡≤ø‡≤∏‡≤ø!","err"); ta.focus(); return; }
      localStorage.setItem("last-script", script);

      // reset
      lockUI(true);
      setStatus(`Generating <span class="dots"><span></span><span></span><span></span></span>`);
      videoEl.src=""; videoEl.style.display="none"; downloadLink.style.display="none";
      startProgress();

      try {
        // --- Kickoff: try /generate first, fallback to root POST (/)
        let kickoff = await fetch(`${WORKER_BASE}/generate`, {
          method:"POST", headers:{"Content-Type":"application/json"},
          body:JSON.stringify({ script, aspect, style })
        });

        if(kickoff.status===404){ // fallback
          kickoff = await fetch(`${WORKER_BASE}`, {
            method:"POST", headers:{"Content-Type":"application/json"},
            body:JSON.stringify({ script, aspect, style })
          });
        }

        if(!kickoff.ok){
          const t = await safeText(kickoff,"‡≤∏‡≤∞‡≥ç‡≤µ‡≤∞‡≥ç ‡≤¶‡≥ã‡≤∑");
          throw new Error(`${kickoff.status} ‚Ä¢ ${t}`);
        }

        const kjson = await kickoff.json();
        // Two possibilities:
        //  (A) { job_id } -> poll
        //  (B) { video_url } (direct) -> done
        if(kjson.video_url){
          showVideo(kjson.video_url);
          return;
        }
        if(!kjson.job_id) throw new Error("Job ID ‡≤∏‡≤ø‡≤ó‡≤≤‡≤ø‡≤≤‡≥ç‡≤≤");

        const url = await pollForVideo(kjson.job_id, 1500, 180000);
        showVideo(url);

      } catch(err){
        console.error(err);
        stopProgress(false);
        const msg = String(err.message||err);
        // few friendly hints
        const hint =
          msg.includes("401") ? "‚Ä¢ REPLICATE_API_TOKEN ‡≤§‡≤™‡≥ç‡≤™‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü ‡≤Ö‡≤•‡≤µ‡≤æ expire ‡≤Ü‡≤ó‡≤ø‡≤¶‡≥Ü." :
          msg.includes("429") ? "‚Ä¢ ‡≤π‡≥Ü‡≤ö‡≥ç‡≤ö‡≥Å requests ‡≤Ü‡≤ó‡≤ø‡≤µ‡≥Ü. ‡≤∏‡≥ç‡≤µ‡≤≤‡≥ç‡≤™ ‡≤π‡≥ä‡≤§‡≥ç‡≤§‡≤ø‡≤® ‡≤¨‡≤≥‡≤ø‡≤ï ‡≤™‡≥ç‡≤∞‡≤Ø‡≤§‡≥ç‡≤®‡≤ø‡≤∏‡≤ø." :
          msg.includes("403") ? "‚Ä¢ Model access permission ‡≤¨‡≥á‡≤ï‡≤ø‡≤∞‡≤¨‡≤π‡≥Å‡≤¶‡≥Å." :
          "";
        setStatus("‚ùå "+ msg + (hint?`<br><small>${hint}</small>`:""), "err");
      } finally {
        lockUI(false);
      }
    }

    function showVideo(url){
      stopProgress(true);
      setStatus("‚úÖ ‡≤µ‡≥Ä‡≤°‡≤ø‡≤Ø‡≥ã ‡≤∏‡≤ø‡≤¶‡≥ç‡≤ß!","ok");
      videoEl.src = url; videoEl.style.display="block";
      downloadLink.href = url;
      downloadLink.setAttribute("download", `ai-video-${new Date().toISOString().replace(/[:.]/g,'-')}.mp4`);
      downloadLink.style.display="inline-block";
    }

    async function pollForVideo(jobId, step=1500, max=180000){
      const t0 = Date.now();
      while(Date.now()-t0 < max){
        // try /status first, fallback to /result
        let r = await fetch(`${WORKER_BASE}/status?job_id=${encodeURIComponent(jobId)}`);
        if(r.status===404){
          r = await fetch(`${WORKER_BASE}/status?job_id=${encodeURIComponent(jobId)}`);
        }
        if(!r.ok) throw new Error(await safeText(r,"Status check failed"));
        const j = await r.json();
        if(j.message) setStatus(j.message);
        if(j.error) throw new Error(j.error);
        if(j.video_url) return j.video_url;
        await sleep(step);
      }
      throw new Error("Timeout ‡≤Ü‡≤Ø‡≤ø‡≤§‡≥Å, ‡≤Æ‡≤§‡≥ç‡≤§‡≥Ü ‡≤™‡≥ç‡≤∞‡≤Ø‡≤§‡≥ç‡≤®‡≤ø‡≤∏‡≤ø.");
    }
  </script>
</body>
</html>
